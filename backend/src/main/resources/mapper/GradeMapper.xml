<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.education.mapper.GradeMapper">
    <select id="findByStudentId" resultMap="gradeResultMap">
        SELECT 
            g.id, g.student_id, g.course_id, g.score, g.created_at,
            c.name as course_name, c.semester, c.credit,
            c.teacher_id, c.classroom_id, cr.name as classroom_name,
            t.name as teacher_name
        FROM grade g
        JOIN course c ON g.course_id = c.id
        JOIN teacher t ON c.teacher_id = t.id
        LEFT JOIN classroom cr ON c.classroom_id = cr.id
        WHERE g.student_id = #{studentId}
        <if test="semester != null and semester != ''">
            AND c.semester = #{semester}
        </if>
        ORDER BY g.created_at DESC
    </select>
    
    <resultMap id="gradeResultMap" type="com.education.entity.Grade">
        <id property="id" column="id"/>
        <result property="studentId" column="student_id"/>
        <result property="courseId" column="course_id"/>
        <result property="score" column="score"/>
        <result property="createdAt" column="created_at"/>
        <association property="course" javaType="com.education.entity.Course">
            <result property="name" column="course_name"/>
            <result property="semester" column="semester"/>
            <result property="credit" column="credit"/>
            <result property="teacherId" column="teacher_id"/>
            <result property="classroomName" column="classroom_name"/>
        </association>
    </resultMap>

    <select id="findStudentsByCourseId" resultType="com.education.dto.StudentGradeDTO">
        SELECT 
            s.id as studentId,
            s.name as studentName,
            g.course_id as courseId,
            c.name as courseName,
            g.score,
            c.semester
        FROM student s
        JOIN course_selection cs ON s.id = cs.student_id
        JOIN course c ON cs.course_id = c.id
        LEFT JOIN grade g ON s.id = g.student_id AND c.id = g.course_id
        WHERE c.id = #{courseId}
    </select>

    <update id="updateGrade">
        UPDATE grade 
        SET score = #{score}
        WHERE student_id = #{studentId} AND course_id = #{courseId}
    </update>

    <update id="batchUpdateGrades">
        <foreach collection="list" item="grade" separator=";">
            UPDATE grade 
            SET score = #{grade.score}
            WHERE student_id = #{grade.studentId} 
            AND course_id = #{grade.courseId}
        </foreach>
    </update>

    <insert id="insert">
        INSERT INTO grade (student_id, course_id, score)
        VALUES (#{studentId}, #{courseId}, #{score})
    </insert>

    <delete id="delete">
        DELETE FROM grade WHERE id = #{id}
    </delete>

    <select id="getCourseGrades" resultType="com.education.entity.StudentGrade">
        SELECT 
            s.id as studentId,
            s.name as studentName,
            s.class_id as className,
            g.score as score,
            g.created_at as updateTime
        FROM student s
        LEFT JOIN grade g ON s.id = g.student_id AND g.course_id = #{courseId}
        WHERE s.id IN (
            SELECT student_id FROM course_selection WHERE course_id = #{courseId}
        )
    </select>

    <update id="updateGradeWithExam">
        INSERT INTO grade (course_id, student_id, score, created_at)
        VALUES (#{courseId}, #{studentId}, #{score}, #{updateTime})
        ON DUPLICATE KEY UPDATE
        score = #{score},
        created_at = #{updateTime}
    </update>

    <update id="publishGrades">
        UPDATE grade SET is_published = 1 WHERE course_id = #{courseId}
    </update>

    <select id="getCourseAverageGrades" resultType="java.util.Map">
        SELECT c.name as course_name,
               AVG(g.score) as average_score
        FROM course c
        LEFT JOIN grade g ON c.id = g.course_id
        WHERE g.is_published = true
        GROUP BY c.id, c.name
    </select>
    
    <select id="getGradeDistribution" resultType="java.util.Map">
        SELECT 
            COUNT(CASE WHEN score &gt;= 90 THEN 1 END) as A,
            COUNT(CASE WHEN score &gt;= 80 AND score &lt; 90 THEN 1 END) as B,
            COUNT(CASE WHEN score &gt;= 70 AND score &lt; 80 THEN 1 END) as C,
            COUNT(CASE WHEN score &gt;= 60 AND score &lt; 70 THEN 1 END) as D,
            COUNT(CASE WHEN score &lt; 60 THEN 1 END) as F
        FROM grade
        WHERE is_published = true
    </select>
    
    <select id="getCoursePassRates" resultType="java.util.Map">
        SELECT c.name,
               COUNT(CASE WHEN g.score &gt;= 60 THEN 1 END) * 100.0 / COUNT(*) as pass_rate
        FROM course c
        LEFT JOIN grade g ON c.id = g.course_id
        WHERE g.is_published = true
        GROUP BY c.id, c.name
    </select>
    
    <select id="findGradeAlerts" resultType="java.util.Map">
        SELECT s.name as student_name,
               c.name as course_name,
               g.score,
               gas.threshold
        FROM grade g
        JOIN student s ON g.student_id = s.id
        JOIN course c ON g.course_id = c.id
        JOIN grade_alert_settings gas ON g.course_id = gas.course_id
        WHERE g.score &lt; gas.threshold
        AND g.is_published = true
        ORDER BY g.score ASC
    </select>
</mapper> 